#

ifndef PIWEB_ROOT_DIR
$(error "YOU MUST DO 'export PIWEB_ROOT_DIR=/absolute/path/to/root/dir/'.")
endif

DIR_PWD  		:= $(shell pwd)
DIR_BASE 		:= $(DIR_PWD)/..

FULL_VERSION	:= $(shell git describe --long --tags --dirty | sed s/-/./g | sed s/^v// )
VER_MAJOR		:= $(shell echo '$(FULL_VERSION)' | awk -F. {'print $$1'})
VER_MINOR		:= $(shell echo '$(FULL_VERSION)' | awk -F. {'print $$2'})
VER_INDEX		:= $(shell echo '$(FULL_VERSION)' | awk -F. {'print $$3'})
VERSION			:= $(VER_MAJOR).$(VER_MINOR).$(VER_INDEX)
BUILD_UTC_TIME	:= $(shell date +'%s')
VERSION_FILE	:= $(DIR_PWD)/piweb/version.py

DUMMY_FILES 	:= $(shell find . -name __pycache__)
INSTALLDIR		:= $(PIWEB_OUTPUT_DIR)/opt/psapps/piweb
SCRIPT_FILES	:= application config config.py piwserver.py public



.PHONY: generate_version

all: generate_version

generate_version:
	@(echo "\n\
	# This file is generated by automatically.\n\
	# Please do not modify or change.\n\
	# \n\
	class Version :\n\
		@staticmethod\n\
		def getVersion() :\n\
			return \"$(VERSION)\"\n\
		@staticmethod\n\
		def getBuildTime() :\n\
			return $(BUILD_UTC_TIME)\n\
	" > $(VERSION_FILE))


clean:
	@find . -name "*.pyc" -exec rm -rf {} \;
	@rm -rf $(DUMMY_FILES)


install: all clean
	@install -d $(INSTALLDIR)
	@(cp -a $(SCRIPT_FILES) $(INSTALLDIR))
